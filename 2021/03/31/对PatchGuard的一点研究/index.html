<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;dark&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="John Doe"><meta name="keywords" content=""><title>对PatchGuard的一点研究 - KillAragorn&#39;s Blog</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"example.com",root:"/",version:"1.8.9",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:"https://hm.baidu.com/hm.js?ac869ccd147869a461a862e3e2b3e282",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><header style="height:100vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>KillAragorn's Blog</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/aier.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="对PatchGuard的一点研究"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-03-31 13:41" pubdate>2021年3月31日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.9k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 45 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">对PatchGuard的一点研究</h1><p class="note note-info">本文最后更新于：几秒前</p><div class="markdown-body"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>​ PatchGuard 是微软公司为windows操作系统对从xp开始的64位操作系统引入的KPP（kernel Patch Protection）机制的一部分，主要目的是保护内核的一些关键数据结构免被第三方驱动修改。它通过定期检查这些关键的数据结构有没有被修改，如果检测到修改，那么windows将会引发一个错误编号为0x109的BSOD，错误代码是 CRITICAL_STRUCTURE_CORRUPTION ，禁止修改的这些关键数据结构在微软官方文档中列出部分。同时，在windbg中使用命令<code>!analyze -show 109</code>同样可以列出一份保护列表。</p><p><img src="https://gitee.com/zaixiabeiming/blog_image/raw/master/images/20210402162329.png" srcset="/img/loading.gif" lazyload alt="PatchGuard保护的数据结构"></p><p><img src="https://gitee.com/zaixiabeiming/blog_image/raw/master/images/20210402162330.png" srcset="/img/loading.gif" lazyload alt="windbg列出保护列表"></p><h3 id="PG工作方式"><a href="#PG工作方式" class="headerlink" title="PG工作方式"></a>PG工作方式</h3><ul><li>大部分PG检测基于context结构体，内容包括<ul><li>一小段自解密代码（ntoskrnl名称为CmpAppendDllSection，这个名字是为了混淆）<img src="2021-03-31-%E5%AF%B9PatchGuard%E7%9A%84%E4%B8%80%E7%82%B9%E7%A0%94%E7%A9%B6/image-20210405103159794.png" srcset="/img/loading.gif" lazyload alt="CmpAppendDllSection 函数代码"> <img src="2021-03-31-%E5%AF%B9PatchGuard%E7%9A%84%E4%B8%80%E7%82%B9%E7%A0%94%E7%A9%B6/image-20210405151115546.png" srcset="/img/loading.gif" lazyload alt="执行中的context的rcx是rip"></li><li>要用到的系统api指针</li><li>重要的api代码备份（例如KiBugCheckEx）</li><li>INITKDBG 节的备份</li><li>要检测的目标地址，大小，checksum 构成的结构体数组</li></ul></li><li>context 大部分时间是处于加密状态，在context执行过程中，由头部进行自解密，如上图所示，context执行时，rcx指向当前rip+4</li><li>context 是在系统初始化时候进行初始化，此时所有数据都是没被修改的</li><li>context 的地址作为系统系统，dpc ，timer等的参数，随着调度被传递</li><li>context 验证逻辑周期约为2min，每次检测的目标块随机。</li><li>context 采用接力的方式进行调度<ul><li>自解密 -&gt; 检测逻辑 -&gt; 复制自身到新的context -&gt; 加密新的context -&gt; 销毁旧的context</li></ul></li><li>context 检测逻辑的调用源具有随机性，在PG初始化时候决定</li></ul><h3 id="攻击方式"><a href="#攻击方式" class="headerlink" title="攻击方式"></a>攻击方式</h3><ul><li>静态补丁攻击：攻击pg初始化<ul><li>优点：一次补丁，终身可用。</li><li>缺点：需要重启，不是动态pass</li></ul></li><li>VT<ul><li>利用vt使PatchGuard保护的数据读写分离</li><li>重载一份新内核，修改msr寄存器的入口点。利用vt隐藏修改的寄存器</li></ul></li><li>定位所有context的调用源头，对源头进行patch<ul><li>源头太多太多，很难全部找到</li></ul></li><li>攻击context：修改 context逻辑<ul><li>搜索内存，初筛context</li><li>基于加密算法特征，定位context</li><li>解密context，修改context逻辑，加密写会context</li></ul></li><li>攻击context：接管页面异常<ul><li>搜索内存，初筛context，设置不可执行</li><li>hook pagefault 接管执行保护异常</li><li>判断是否是context调用，修改context代码直接返回</li></ul></li><li>攻击 DPC 调用<ul><li>在KiRetireDpcList处保存context，如果发生109蓝屏，直接恢复保存的环境（老v时光倒流大法）</li></ul></li></ul><h3 id="实验：win7（攻击context代码）"><a href="#实验：win7（攻击context代码）" class="headerlink" title="实验：win7（攻击context代码）"></a>实验：win7（攻击context代码）</h3><p>​ win7的pg执行点是CmpAppendDllSection函数的备份，这份代码在运行时会进行自解密，以rdx为key，解密代码。</p><p>这里的解密算法有一个破绽，假设</p><p>CmpAppendDllSection+0x0的密文内容为A，大小8字节；</p><p>CmpAppendDllSection+0x0的明文内容为B，大小8字节；</p><p>CmpAppendDllSection+0x8的密文内容为C，大小8字节；</p><p>CmpAppendDllSection+0x8的明文内容为D，大小8字节；</p><p>它们因为都是经过key解密出来的，所以有一个这样的关系：A ^ B == C ^ D。</p><p>我们遍历可能的context时，为了判断是否是pg的context就可以使用这样的方式。读出内容，然后使A ^ B == C ^ D 表达式成立，成立之后，就可以得到key的值，从而解密出整个context，修改完成之后再加密回去。这是这种方法的主要逻辑。</p><ul><li><p>扫描可能context</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DestroyPatchGuardByPool</span><span class="hljs-params">(PATCH_GUARG_CONTEXT *pPatchGuardContext)</span></span><br><span class="hljs-function"></span>&#123;<br>		ULONG_PTR	Index;<br>		ULONG_PTR	StartAddress;<br><br>		POOL_TRACKER_BIG_PAGES	PoolTrackerBigPagesItem;<br><br>		<span class="hljs-keyword">for</span> (Index = <span class="hljs-number">0</span>; Index &lt; *(ULONG_PTR*)pPatchGuardContext-&gt;lpkvPoolBigPageTableSize; Index++)<br>		&#123;<br>			PoolTrackerBigPagesItem = pPatchGuardContext-&gt;lpkvPoolBigPageTable[Index];<br>			StartAddress = (ULONG_PTR)PoolTrackerBigPagesItem.Va;<br><br>			<span class="hljs-keyword">if</span> (StartAddress == <span class="hljs-number">0</span> || (StartAddress &amp; <span class="hljs-number">0x1</span>) != <span class="hljs-number">0</span>)	<span class="hljs-comment">//为0或1代表未使用</span><br>			&#123;<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br><br>			<span class="hljs-comment">//我们只扫描非换页内存池的</span><br>			<span class="hljs-keyword">if</span> (StartAddress &lt; *(ULONG_PTR*)pPatchGuardContext-&gt;lpkvMiNonPagedPoolStartAligned)<br>			&#123;<br>				<span class="hljs-comment">//非换页内存池</span><br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br><br>			AttackPatchGuard((PUCHAR)StartAddress, (ULONG)PoolTrackerBigPagesItem.NumberOfBytes);<br>		&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>攻击 context（1）</p></li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function">BOOLEAN <span class="hljs-title">AttackPatchGuard</span><span class="hljs-params">(PUCHAR MemStart, ULONG MemSize)</span></span><br><span class="hljs-function"></span>&#123;<br>	ULONG_PTR Key = <span class="hljs-number">0</span>;<br>	ULONG_PTR Count;<br>	ULONG_PTR SearchStart = (ULONG_PTR)MemStart;<br><br>	<span class="hljs-comment">//因为下面的搜索最少要求memSize大于0x98，所以我们要在这里判断一下</span><br>	<span class="hljs-keyword">if</span> (MemSize &lt; <span class="hljs-number">0x100</span>)	<span class="hljs-comment">//判断大点儿</span><br>	&#123;<br>		<span class="hljs-keyword">return</span> FALSE;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (MmIsAddressValid(MemStart) == FALSE || MmIsAddressValid(MemStart + MemSize - <span class="hljs-keyword">sizeof</span>(ULONG_PTR)) == FALSE)<br>	&#123;<br>		<span class="hljs-keyword">return</span> FALSE;<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> (Count = <span class="hljs-number">0</span>; Count &lt; MemSize; Count++)<br>	&#123;<br><br>		<span class="hljs-comment">//下面是对明文context的处理</span><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">141</span> + <span class="hljs-number">22</span>) &lt; MemSize &amp;&amp; \<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)(SearchStart + Count + <span class="hljs-number">141</span>), <span class="hljs-string">&quot;\x48\x31\x84\xCA\xC0\x00\x00\x00\x48\xD3\xC8\xE2\xF3\x8B\x82\x88\x02\x00\x00\x48\x03\xC2&quot;</span>, <span class="hljs-number">22</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;CmpAppendDllSection address:%p&quot;</span>, SearchStart + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;CmpAppendDllSection address content:%p&quot;</span>, *(ULONG_PTR*)(SearchStart + Count));<br>			<span class="hljs-built_in">memcpy</span>((PUCHAR)SearchStart + Count + <span class="hljs-number">0x8</span>, <span class="hljs-string">&quot;\xC3\x90\x90\x90&quot;</span>, <span class="hljs-number">4</span>);<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">26</span> + <span class="hljs-number">20</span>) &lt; MemSize &amp;&amp;\<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)(SearchStart + Count + <span class="hljs-number">26</span>), <span class="hljs-string">&quot;\x41\x57\x48\x81\xEC\x50\x06\x00\x00\x48\x8D\xA8\x58\xFA\xFF\xFF\x48\x83\xE5\x80&quot;</span>, <span class="hljs-number">20</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;FsRtlMdlReadCompleteDevEx address:%p&quot;</span>, SearchStart + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;FsRtlMdlReadCompleteDevEx address content:%p&quot;</span>, *(ULONG_PTR*)(SearchStart + Count));<br>			*(ULONG32*)(SearchStart + Count) = <span class="hljs-number">0xC3C03148</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">15</span> + <span class="hljs-number">26</span>) &lt; MemSize &amp;&amp;\<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)(SearchStart + Count + <span class="hljs-number">15</span>), <span class="hljs-string">&quot;\x8B\x82\x88\x02\x00\x00\x48\x03\xC2\x48\x83\xEC\x28\xFF\xD0\x48\x83\xC4\x28\x4C\x8B\x80\xE8\x00\x00\x00&quot;</span>, <span class="hljs-number">26</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-comment">//因为RtlLookupFunctionEntryEx这句lea     rdx, [rcx-1000h]变动的，无法定位，而利用其它的特征码又和CmpAppendDllSection相同了，所以这里我们判断一下头8个字节的特征</span><br>			<span class="hljs-keyword">if</span> (*(ULONG_PTR*)(SearchStart + Count) == <span class="hljs-number">0x085131481131482E</span>)<br>			&#123;<br>				LOG_DEBUG(<span class="hljs-string">&quot;RtlLookupFunctionEntryEx address:%p&quot;</span>, SearchStart + Count);<br>				LOG_DEBUG(<span class="hljs-string">&quot;RtlLookupFunctionEntryEx address content:%p&quot;</span>, *(ULONG_PTR*)(SearchStart + Count + <span class="hljs-number">0xF</span> - <span class="hljs-number">0x8</span>));<br>				<span class="hljs-built_in">memcpy</span>((PUCHAR)SearchStart + Count + <span class="hljs-number">8</span>, <span class="hljs-string">&quot;\xC3\x90\x90\x90\x90\x90\x90&quot;</span>, <span class="hljs-number">7</span>);<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">15</span> + <span class="hljs-number">14</span>) &lt; MemSize &amp;&amp;\<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)(SearchStart + Count + <span class="hljs-number">15</span>), <span class="hljs-string">&quot;\x33\xC0\x49\x89\x02\x49\x83\xEA\x08\x4C\x3B\xD4\x73\xF4&quot;</span>, <span class="hljs-number">14</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;SdbpCheckDll address:%p&quot;</span>, SearchStart + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;SdbpCheckDll address content:%p&quot;</span>, *(ULONG_PTR*)(SearchStart + Count));<br>			*(UCHAR*)(SearchStart + Count) = <span class="hljs-number">0xC3</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">2</span> + <span class="hljs-number">15</span>) &lt; MemSize &amp;&amp; \<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)(SearchStart + Count + <span class="hljs-number">2</span>), <span class="hljs-string">&quot;\x9C\x48\x83\xEC\x20\x8B\x44\x24\x20\x45\x33\xC9\x45\x33\xC0&quot;</span>, <span class="hljs-number">15</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;KiTimerDispatch address:%p&quot;</span>, SearchStart + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;KiTimerDispatch address content:%p&quot;</span>, *(ULONG_PTR*)(SearchStart + Count));<br>			<span class="hljs-built_in">memcpy</span>((PUCHAR)SearchStart + Count + <span class="hljs-number">3</span>, <span class="hljs-string">&quot;\x59\xC3&quot;</span>, <span class="hljs-number">2</span>);	<span class="hljs-comment">//pop rcx  retn</span><br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">42</span> + <span class="hljs-number">24</span>) &lt; MemSize &amp;&amp; \<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)(SearchStart + Count + <span class="hljs-number">42</span>), <span class="hljs-string">&quot;\x48\x8B\xDA\xBA\x26\x00\x00\x00\x41\xB8\x30\x01\x00\x00\x48\x8D\x85\x80\x00\x00\x00\x45\x33\xFF&quot;</span>, <span class="hljs-number">24</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;sub_1401A2010 address:%p&quot;</span>, SearchStart + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;sub_1401A2010 address content:%p&quot;</span>, *(ULONG_PTR*)(SearchStart + Count));<br>		&#125;<br><br>		<span class="hljs-comment">//////////////////////////////////////////////////////////////////////////</span><br>		<span class="hljs-comment">//下面是对密文context的处理</span><br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		INIT:000000014057224B						loc_14057224B:                          ; CODE XREF: CmpAppendDllSection+98j</span><br><span class="hljs-comment">		INIT:000000014057224B 48 31 84 CA C0 00 00 00			xor     [rdx+rcx*8+0C0h], rax</span><br><span class="hljs-comment">		INIT:0000000140572253 48 D3 C8							ror     rax, cl</span><br><span class="hljs-comment">		INIT:0000000140572256 E2 F3								loop    loc_14057224B</span><br><span class="hljs-comment">		INIT:0000000140572258 8B 82 88 02 00 00					mov     eax, [rdx+288h]</span><br><span class="hljs-comment">		INIT:000000014057225E 48 03 C2							add     rax, rdx</span><br><span class="hljs-comment">		INIT:0000000140572261 48 83 EC 28						sub     rsp, 28h</span><br><span class="hljs-comment">		INIT:0000000140572265 FF D0								call    rax</span><br><span class="hljs-comment">		INIT:0000000140572267 48 83 C4 28						add     rsp, 28h</span><br><span class="hljs-comment">		*/</span><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">0xc0</span> + <span class="hljs-number">0x8</span>) &lt; MemSize)<br>		&#123;<br>			Key = *(ULONG_PTR*)(SearchStart + Count + <span class="hljs-number">0x8D</span>) ^ <span class="hljs-number">0x000000C0CA843148</span>;<br>			<span class="hljs-keyword">if</span> (Key != <span class="hljs-number">0</span> &amp;&amp; (*(ULONG_PTR*)(SearchStart + Count + <span class="hljs-number">0x8D</span> + <span class="hljs-number">0x08</span>) ^ <span class="hljs-number">0x88828BF3E2C8D348</span>) == Key &amp;&amp;<br>				(*(ULONG_PTR*)(SearchStart + Count + <span class="hljs-number">0x8D</span> + <span class="hljs-number">0x10</span>) ^ <span class="hljs-number">0x8348C20348000002</span>) == Key &amp;&amp;<br>				(*(ULONG_PTR*)(SearchStart + Count + <span class="hljs-number">0x8D</span> + <span class="hljs-number">0x18</span>) ^ <span class="hljs-number">0x28C48348D0FF28EC</span>) == Key)<br>			&#123;<br>				ULONG_PTR	ContextSize;<br>				ULONG_PTR	ContextKey;<br><br>				<span class="hljs-comment">//ContextKey是解密出来的context key</span><br>				ContextKey = (*(ULONG_PTR*)(SearchStart + Count + <span class="hljs-number">0x8</span>)) ^ <span class="hljs-number">0x1851314810513148</span>;<br>				ContextSize = ((*(ULONG_PTR*)(SearchStart + Count + <span class="hljs-number">0xc0</span>)) ^ ContextKey) &gt;&gt; <span class="hljs-number">32</span>;	<span class="hljs-comment">//context+0xc4是保存从+0xc8偏移context后面整个加密长度,注意只有4字节</span><br><br>																								<span class="hljs-comment">//判断一下长度是否越界</span><br>				<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">0xc8</span> + ContextSize * <span class="hljs-number">0x8</span>) &lt;= MemSize)<br>				&#123;<br>					<span class="hljs-comment">//找到了，我们进行处理pg的行为吧</span><br>					DynamicAttackPatchguardEncryptCode((PUCHAR)SearchStart + Count, <span class="hljs-number">0xc8</span> + ContextSize * <span class="hljs-number">0x8</span>, ContextKey);<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> FALSE;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>攻击 context（2）</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DynamicAttackPatchguardEncryptCode</span><span class="hljs-params">(PUCHAR Context, ULONG_PTR Size, ULONG_PTR Key)</span></span><br><span class="hljs-function"></span>&#123;<br>	ULONG_PTR	Count, Index;<br>	PULONG_PTR	lpDecryptMem;<br>	ULONG_PTR	ContextKey;<br>	ULONG_PTR	DecryptSize;<br>	UCHAR		RorBit;<br><br>	ContextKey = Key;<br><br>	<span class="hljs-comment">//申请一块内存，用来解密的！</span><br>	lpDecryptMem = (PULONG_PTR)ExAllocatePool(NonPagedPool, Size);<br>	RtlCopyMemory(lpDecryptMem, Context, Size);<br><br>	<span class="hljs-comment">//首先解密出context头部的CmpAppendDllSection解密函数</span><br>	<span class="hljs-keyword">for</span> (Count = <span class="hljs-number">0</span>; Count &lt; <span class="hljs-number">0xc8</span> / <span class="hljs-keyword">sizeof</span>(ULONG_PTR); Count++)<br>	&#123;<br>		lpDecryptMem[Count] ^= ContextKey;<br>	&#125;<br><br>	<span class="hljs-comment">//算出解密长度</span><br>	DecryptSize = lpDecryptMem[<span class="hljs-number">0xc0</span> / <span class="hljs-keyword">sizeof</span>(ULONG_PTR)] &gt;&gt; <span class="hljs-number">32</span>;<br>	Index = DecryptSize;<br><br>	<span class="hljs-comment">//然后解密出剩下的部分</span><br>	<span class="hljs-keyword">do</span><br>	&#123;<br>		lpDecryptMem[(<span class="hljs-number">0xc8</span> / <span class="hljs-keyword">sizeof</span>(ULONG_PTR) - <span class="hljs-number">1</span>) + Index] ^= ContextKey;<br>		RorBit = (UCHAR)Index;<br>		ContextKey = _rotr64(ContextKey, RorBit);<br>	&#125; <span class="hljs-keyword">while</span> (--Index);<br><br>	<span class="hljs-comment">//解密完成~~</span><br>	<span class="hljs-keyword">for</span> (Count = <span class="hljs-number">0</span>; Count &lt; Size; Count++)<br>	&#123;<br>		<span class="hljs-comment">//下面是对明文context的处理</span><br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">141</span> + <span class="hljs-number">22</span>) &lt; Size &amp;&amp; \<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)((ULONG_PTR)lpDecryptMem + Count + <span class="hljs-number">141</span>), <span class="hljs-string">&quot;\x48\x31\x84\xCA\xC0\x00\x00\x00\x48\xD3\xC8\xE2\xF3\x8B\x82\x88\x02\x00\x00\x48\x03\xC2&quot;</span>, <span class="hljs-number">22</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;--CmpAppendDllSection address:%p&quot;</span>, (ULONG_PTR)lpDecryptMem + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;--CmpAppendDllSection address content:%p&quot;</span>, *(ULONG_PTR*)((ULONG_PTR)lpDecryptMem + Count));<br>			<span class="hljs-built_in">memcpy</span>((PUCHAR)lpDecryptMem + Count + <span class="hljs-number">0x8</span>, <span class="hljs-string">&quot;\xC3\x90\x90\x90&quot;</span>, <span class="hljs-number">4</span>);<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">26</span> + <span class="hljs-number">20</span>) &lt; Size &amp;&amp; \<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)((ULONG_PTR)lpDecryptMem + Count + <span class="hljs-number">26</span>), <span class="hljs-string">&quot;\x41\x57\x48\x81\xEC\x50\x06\x00\x00\x48\x8D\xA8\x58\xFA\xFF\xFF\x48\x83\xE5\x80&quot;</span>, <span class="hljs-number">20</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;--FsRtlMdlReadCompleteDevEx address:%p&quot;</span>, (ULONG_PTR)lpDecryptMem + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;--FsRtlMdlReadCompleteDevEx address content:%p&quot;</span>, *(ULONG_PTR*)((ULONG_PTR)lpDecryptMem + Count));<br>			 <span class="hljs-comment">//xor rax,rax</span><br>			 <span class="hljs-comment">//retn</span><br>			*(ULONG32*)((ULONG_PTR)lpDecryptMem + Count) = <span class="hljs-number">0xC3C03148</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">15</span> + <span class="hljs-number">26</span>) &lt; Size &amp;&amp; \<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)((ULONG_PTR)lpDecryptMem + Count + <span class="hljs-number">15</span>), <span class="hljs-string">&quot;\x8B\x82\x88\x02\x00\x00\x48\x03\xC2\x48\x83\xEC\x28\xFF\xD0\x48\x83\xC4\x28\x4C\x8B\x80\xE8\x00\x00\x00&quot;</span>, <span class="hljs-number">26</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-comment">//因为RtlLookupFunctionEntryEx这句lea     rdx, [rcx-1000h]变动的，无法定位，而利用其它的特征码又和CmpAppendDllSection相同了，所以这里我们判断一下头8个字节的特征</span><br>			<span class="hljs-keyword">if</span> (*(ULONG_PTR*)((ULONG_PTR)lpDecryptMem + Count) == <span class="hljs-number">0x085131481131482E</span>)<br>			&#123;<br>				LOG_DEBUG(<span class="hljs-string">&quot;--RtlLookupFunctionEntryEx address:%p&quot;</span>, (ULONG_PTR)lpDecryptMem + Count);<br>				LOG_DEBUG(<span class="hljs-string">&quot;--RtlLookupFunctionEntryEx address content:%p&quot;</span>, *(ULONG_PTR*)((ULONG_PTR)lpDecryptMem + Count + <span class="hljs-number">0xF</span> - <span class="hljs-number">0x8</span>));<br>				<span class="hljs-built_in">memcpy</span>((PUCHAR)lpDecryptMem + Count + <span class="hljs-number">8</span>, <span class="hljs-string">&quot;\xC3\x90\x90\x90\x90\x90\x90&quot;</span>, <span class="hljs-number">7</span>);<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">15</span> + <span class="hljs-number">14</span>) &lt; Size &amp;&amp; \<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)((ULONG_PTR)lpDecryptMem + Count + <span class="hljs-number">15</span>), <span class="hljs-string">&quot;\x33\xC0\x49\x89\x02\x49\x83\xEA\x08\x4C\x3B\xD4\x73\xF4&quot;</span>, <span class="hljs-number">14</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;--SdbpCheckDll address:%p&quot;</span>, (ULONG_PTR)lpDecryptMem + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;--SdbpCheckDll address content:%p&quot;</span>, *(ULONG_PTR*)((ULONG_PTR)lpDecryptMem + Count));<br>			*(UCHAR*)((ULONG_PTR)lpDecryptMem + Count) = <span class="hljs-number">0xC3</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">2</span> + <span class="hljs-number">15</span>) &lt; Size &amp;&amp; \<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)((ULONG_PTR)lpDecryptMem + Count + <span class="hljs-number">2</span>), <span class="hljs-string">&quot;\x9C\x48\x83\xEC\x20\x8B\x44\x24\x20\x45\x33\xC9\x45\x33\xC0&quot;</span>, <span class="hljs-number">15</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;--KiTimerDispatch address:%p&quot;</span>, (ULONG_PTR)lpDecryptMem + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;--KiTimerDispatch address content:%p&quot;</span>, *(ULONG_PTR*)((ULONG_PTR)lpDecryptMem + Count));<br>			<span class="hljs-built_in">memcpy</span>((PUCHAR)lpDecryptMem + Count + <span class="hljs-number">3</span>, <span class="hljs-string">&quot;\x59\xC3&quot;</span>, <span class="hljs-number">2</span>);	<span class="hljs-comment">//pop rcx  retn</span><br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((Count + <span class="hljs-number">42</span> + <span class="hljs-number">24</span>) &lt; Size &amp;&amp; \<br>			<span class="hljs-built_in">memcmp</span>((<span class="hljs-keyword">void</span>*)((ULONG_PTR)lpDecryptMem + Count + <span class="hljs-number">42</span>), <span class="hljs-string">&quot;\x48\x8B\xDA\xBA\x26\x00\x00\x00\x41\xB8\x30\x01\x00\x00\x48\x8D\x85\x80\x00\x00\x00\x45\x33\xFF&quot;</span>, <span class="hljs-number">24</span>) == <span class="hljs-number">0</span>)<br>		&#123;<br>			LOG_DEBUG(<span class="hljs-string">&quot;--sub_1401A2010 address:%p&quot;</span>, (ULONG_PTR)lpDecryptMem + Count);<br>			LOG_DEBUG(<span class="hljs-string">&quot;--sub_1401A2010 address content:%p&quot;</span>, *(ULONG_PTR*)((ULONG_PTR)lpDecryptMem + Count));<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">//加密回去</span><br>	<span class="hljs-keyword">for</span> (Count = <span class="hljs-number">0</span>; Count &lt; <span class="hljs-number">0xc8</span> / <span class="hljs-keyword">sizeof</span>(ULONG_PTR); Count++)<br>	&#123;<br>		lpDecryptMem[Count] ^= ContextKey;<br>	&#125;<br><br>	Index = DecryptSize;<br><br>	<span class="hljs-comment">//然后加密出剩下的部分</span><br>	<span class="hljs-keyword">do</span><br>	&#123;<br>		lpDecryptMem[(<span class="hljs-number">0xc8</span> / <span class="hljs-keyword">sizeof</span>(ULONG_PTR) - <span class="hljs-number">1</span>) + Index] ^= ContextKey;<br>		RorBit = (UCHAR)Index;<br>		ContextKey = _rotr64(ContextKey, RorBit);<br>	&#125; <span class="hljs-keyword">while</span> (--Index);<br><br>	<span class="hljs-comment">//copy回去</span><br>	RtlCopyMemory(Context, lpDecryptMem, Size);<br><br>	ExFreePool(lpDecryptMem);<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="实验：win10（hook-页错误处理）"><a href="#实验：win10（hook-页错误处理）" class="headerlink" title="实验：win10（hook 页错误处理）"></a>实验：win10（hook 页错误处理）</h3><p>win10之后，微软对context的加密算法进行了升级，攻击context变得困难（shark牛逼，飞总牛逼），所以这次我们来用一下hook fault的方法。</p><ul><li>扫描可能context，设置不可执行</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">status = ZwQuerySystemInformation(<span class="hljs-number">0x42</span>, g_BigPoolInfo, retLength + <span class="hljs-number">0x1000</span>, &amp;retLength);<br><br><span class="hljs-keyword">if</span> ( status != STATUS_SUCCESS ) &#123;<br>	KdPrint((<span class="hljs-string">&quot;[Pg_test] : ZwQuerySystemInformation - query error: %p\n&quot;</span>), status);<br>	<span class="hljs-keyword">return</span>;<br>&#125;<br><br>KdPrint((<span class="hljs-string">&quot;[Pg_test] : g_BigPoolInfo %p \n&quot;</span>, g_BigPoolInfo));<br>KdPrint((<span class="hljs-string">&quot;[Pg_test] : pool count is %ud \n&quot;</span>, g_BigPoolInfo-&gt;count));<br><span class="hljs-keyword">for</span> (ULONG i = <span class="hljs-number">0</span>; i &lt; g_BigPoolInfo-&gt;count; i++) &#123;<br>	<span class="hljs-comment">// size &gt; context_size(xx)</span><br>	<span class="hljs-keyword">if</span> (g_BigPoolInfo-&gt;AllocatedInfo[i].SizeInBytes &gt; <span class="hljs-number">0x8000</span>)&#123;<br>		PVOID context_addr = g_BigPoolInfo-&gt;AllocatedInfo[i].VirtualAddress;<br>		PULONG64 ppte = GetPteAddress(context_addr);<br>		ULONG64 pte = *( PULONG64 )ppte;<br>		ULONG64 ppde = GetPdeAddress(context_addr);<br>		ULONG64 pde = *( PULONG64 )ppde;<br><br>		<span class="hljs-comment">// not large page</span><br>		<span class="hljs-keyword">if</span> ( !(pde &amp; <span class="hljs-number">0x80</span>) ) 	&#123;<br>			<span class="hljs-keyword">if</span> ( (pte &amp; <span class="hljs-number">0x8000000000000000</span>) == <span class="hljs-number">0</span> &amp;&amp; (pte &amp; <span class="hljs-number">1</span>) ) &#123;<br>				pte |= <span class="hljs-number">0x8000000000000000</span>;<br>				<span class="hljs-comment">// context can not excute, so ... pagefault..</span><br>				*ppte = pte;<br>				KdPrint((<span class="hljs-string">&quot;[Pg_test] : contextAddr: %p, size: %p, pte: %p\n&quot;</span>, context_addr, g_BigPoolInfo-&gt;AllocatedInfo[i].SizeInBytes, pte));<br>				contextNum++;<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br>KdPrint((<span class="hljs-string">&quot;[Pg_test] :context count : %d\n&quot;</span>), contextNum);<br></code></pre></div></td></tr></table></figure><ul><li>hook pagefaut<ul><li>判断是否是context的特征，是就返回，不是就跳转到原先的异常处理</li><li>这里hook时候要注意，win10 1809（不确定）系统有影子页表，不要hook shadow 处理，更新好了cr3之后再去hook，也就是真正的页错误处理</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">Asm_hook_PageFault	Proc<br><br><br>        push rcx<br><br>        mov rax, [rsp + 10h]      ;error code<br>        cmp rax, 11h<br>        jnz @back<br><br><br>        mov rax, [rsp + 18h]    ;addr<br>        mov eax, dword ptr [rax]<br>        cmp eax, 1131482eh<br>        jnz @back<br><br>    	; 这里是为了记录pg的context，方便查找调用源<br>        mov [DebugData + 30h], rdx<br>;----------------------------------------<br>        mov rax, [DebugData+10h]<br>        inc rax<br>        mov [DebugData+10h], rax<br>        mov [DebugData+18h], rcx<br><br>        mov rax, [rsp + 18h]    ;addr<br>        mov [DebugData+20h], rax<br><br>		; 这里是直接返回到context的调用源，不是修改context的汇编为ret<br>        mov rax, [rsp+28h]  ;efl<br>        push rax<br>        popfq<br>        mov rax, [rsp+38h]  ;ss<br>        mov ss, ax<br>        mov rax, [rsp+30h]  ;rsp<br>        mov [DebugData+40h], rax<br>        mov rsp, rax<br><br>        ret<br>;-----------------------------------------<br><br>@back:<br>        pop rcx<br>        pop rax<br>        push rbp<br>        sub rsp, 158h<br>        lea rbp, [rsp+80h]<br>        sub rsp, 8<br>        mov dword ptr [rsp], (NT_BASE+ 1CA450h)and 0ffffffffh<br>        mov dword ptr [rsp+4], NT_BASE shr 32<br>        ret<br>Asm_hook_PageFault 	Endp<br></code></pre></div></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/debugger/bug-check-0x109---critical-structure-corruption">Bug 检查 0x109 CRITICAL_STRUCTURE_CORRUPTION - Windows drivers | Microsoft Docs</a></p></li><li><p><a target="_blank" rel="noopener" href="https://github.com/killvxk/DisableWin10PatchguardPoc">https://github.com/killvxk/DisableWin10PatchguardPoc</a></p></li><li><p><a target="_blank" rel="noopener" href="https://github.com/tandasat/PgResarch">https://github.com/tandasat/PgResarch</a></p></li><li><p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-148451.htm">https://bbs.pediy.com/thread-148451.htm</a></p></li></ul></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/windows%E5%86%85%E6%A0%B8/">windows内核</a> <a class="hover-with-bg" href="/categories/windows%E5%86%85%E6%A0%B8/%E9%80%86%E5%90%91/">逆向</a> <a class="hover-with-bg" href="/categories/windows%E5%86%85%E6%A0%B8/%E9%80%86%E5%90%91/windows/">windows</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/windows%E5%86%85%E6%A0%B8/">windows内核</a> <a class="hover-with-bg" href="/tags/%E9%80%86%E5%90%91/">逆向</a> <a class="hover-with-bg" href="/tags/PatchGuard/">PatchGuard</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/2021/04/01/win%20x64%E5%AF%BB%E5%9D%80%E6%A8%A1%E5%BC%8F%E5%8F%8A%E8%8E%B7%E5%8F%96PTE_BASE/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">win64位寻址模式及获取随机PTE_BASE</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021/03/25/%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90irq%E4%B8%8Eirql%EF%BC%9A%E4%BB%8Epic%E5%88%B0apic/"><span class="hidden-mobile">深入解析irq与irql：从pic到apic</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/killaragorn/" target="_blank" rel="nofollow noopener"><span>KillAragorn</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/js/local-search.js"></script><script>$("#local-search-input").on("click",(function(){searchFunc("/local-search.xml","local-search-input","local-search-result")})),$("#modalSearch").on("shown.bs.modal",(function(){$("#local-search-input").focus()}))</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?https://hm.baidu.com/hm.js?ac869ccd147869a461a862e3e2b3e282";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="/js/boot.js"></script></body></html>