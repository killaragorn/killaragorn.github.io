<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;dark&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="John Doe"><meta name="keywords" content=""><title>MiniFilter 文件过滤框架复习 - KillAragorn&#39;s Blog</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"example.com",root:"/",version:"1.8.9",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:"https://hm.baidu.com/hm.js?ac869ccd147869a461a862e3e2b3e282",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><header style="height:100vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>KillAragorn's Blog</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/aier.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="MiniFilter 文件过滤框架复习"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-04-07 13:23" pubdate>2021年4月7日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.6k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 36 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">MiniFilter 文件过滤框架复习</h1><div class="markdown-body"><h3 id="Minifile-与-Sfilter-的区别"><a href="#Minifile-与-Sfilter-的区别" class="headerlink" title="Minifile 与 Sfilter 的区别"></a>Minifile 与 Sfilter 的区别</h3><ul><li>minifilter 比 sfilter 加载顺序更易控制（sfilter处于设备栈中的顺序由过滤驱动加载顺序不同而不同），altitude由filter管理器根据这个altitude值(值越大越上层)调用驱动回调，被绑定到合适的位置。<ul><li>由于minifilter的altitude值决定过滤驱动在filter的管理器中处理数据的先后，反病毒驱动一般在高处，透明管加解密一般在低处。</li><li>微软也将altitude分配了几个组</li></ul></li></ul><p><img src="https://github.com/killaragorn/blog_image/raw/main/images/20210407204438.png" srcset="/img/loading.gif" lazyload alt="image-20210407202622438"></p><ul><li>安全卸载能力：向filter管理器取消注册</li><li>callback模型仅需处理必要的操作的能力</li><li>兼容性更好</li><li>名字处理更容易</li><li>安装方式（.inf、动态加载（比传统的nt驱动需要多创建几个键））</li><li>专用的通信方式</li><li>同样要遵循内核驱动编码规则，irql，锁等内核开发通用机制</li><li>当系统中同时存在minifilter和legacy filter时</li></ul><p><img src="https://github.com/killaragorn/blog_image/raw/main/images/20210415105116.png" srcset="/img/loading.gif" lazyload alt="总体框架"></p><h3 id="minifilter-过滤框架"><a href="#minifilter-过滤框架" class="headerlink" title="minifilter 过滤框架"></a>minifilter 过滤框架</h3><ul><li><p>驱动入口：初始化 FLT_REGISTRATION 结构体 ，向过滤管理器注册和启动：FltRegisterFilter，FltStartFiltering</p><p><img src="https://github.com/killaragorn/blog_image/raw/main/images/20210415105117.png" srcset="/img/loading.gif" lazyload alt="minifilter结构"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><code class="hljs c">PFLT_FILTER g_pFilter = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">const</span> FLT_CONTEXT_REGISTRATION <br>ContextRegistration[] = <br>&#123;<span class="hljs-comment">//在释放context之前调用，可以在此释放context里的内存等</span><br>&#123; 	<br>FLT_INSTANCE_CONTEXT,<br><span class="hljs-number">0</span>,<br>CtxContextCleanup,<br>CTX_INSTANCE_CONTEXT_SIZE,<br>CTX_INSTANCE_CONTEXT_TAG <br>&#125;,<br>&#123;	 <br>	FLT_FILE_CONTEXT,<br><span class="hljs-number">0</span>,<br>CtxContextCleanup,<br>CTX_FILE_CONTEXT_SIZE,<br>CTX_FILE_CONTEXT_TAG <br>&#125;,<br>&#123; 	<br>	FLT_STREAM_CONTEXT,<br><span class="hljs-number">0</span>,<br>CtxContextCleanup,<br>CTX_STREAM_CONTEXT_SIZE,<br>CTX_STREAM_CONTEXT_TAG<br> &#125;,<br>&#123;	<br>	FLT_STREAMHANDLE_CONTEXT,<br><span class="hljs-number">0</span>,<br>CtxContextCleanup,<br>CTX_STREAMHANDLE_CONTEXT_SIZE,<br>CTX_STREAMHANDLE_CONTEXT_TAG<br> &#125;,<br>&#123; FLT_CONTEXT_END &#125;<br>&#125;;<br><br><br>CONST FLT_REGISTRATION FilterRegistration = &#123;<br><br>    <span class="hljs-keyword">sizeof</span>( FLT_REGISTRATION ),         <span class="hljs-comment">//  Size</span><br>    FLT_REGISTRATION_VERSION,           <span class="hljs-comment">//  Version</span><br>    <span class="hljs-number">0</span>,                                  <span class="hljs-comment">//  Flags</span><br><br>    ContextRegistration,                               <span class="hljs-comment">//  Context</span><br>    Callbacks,                          <span class="hljs-comment">//  Operation callbacks</span><br><br>    PtUnload,                           <span class="hljs-comment">//  MiniFilterUnload</span><br><br>    PtInstanceSetup,                    <span class="hljs-comment">//  InstanceSetup</span><br>    PtInstanceQueryTeardown,            <span class="hljs-comment">//  InstanceQueryTeardown</span><br>    PtInstanceTeardownStart,            <span class="hljs-comment">//  InstanceTeardownStart</span><br>    PtInstanceTeardownComplete,         <span class="hljs-comment">//  InstanceTeardownComplete</span><br><br>    <span class="hljs-literal">NULL</span>,                               <span class="hljs-comment">//  GenerateFileName</span><br>    <span class="hljs-literal">NULL</span>,                               <span class="hljs-comment">//  GenerateDestinationFileName</span><br>    <span class="hljs-literal">NULL</span>                                <span class="hljs-comment">//  NormalizeNameComponent</span><br><br>&#125;;<br><br>CONST FLT_OPERATION_REGISTRATION Callbacks[] = &#123;<br>    &#123; IRP_MJ_CREATE,<br>      <span class="hljs-number">0</span>,<br>      PtCreatePreOperationPassThrough,<br>      PtCreatePostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_CREATE_NAMED_PIPE,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_CLOSE,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_READ,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_WRITE,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_QUERY_INFORMATION,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_SET_INFORMATION,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_QUERY_EA,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_SET_EA,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_FLUSH_BUFFERS,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_QUERY_VOLUME_INFORMATION,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_SET_VOLUME_INFORMATION,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_DIRECTORY_CONTROL,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_FILE_SYSTEM_CONTROL,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_DEVICE_CONTROL,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_INTERNAL_DEVICE_CONTROL,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_SHUTDOWN,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationNoPostOperationPassThrough,<br>      <span class="hljs-literal">NULL</span> &#125;,                               <span class="hljs-comment">//post operations not supported</span><br><br>    &#123; IRP_MJ_LOCK_CONTROL,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_CLEANUP,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_CREATE_MAILSLOT,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_QUERY_SECURITY,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_SET_SECURITY,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_QUERY_QUOTA,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_SET_QUOTA,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_PNP,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_RELEASE_FOR_SECTION_SYNCHRONIZATION,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_ACQUIRE_FOR_MOD_WRITE,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_RELEASE_FOR_MOD_WRITE,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_ACQUIRE_FOR_CC_FLUSH,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_RELEASE_FOR_CC_FLUSH,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_FAST_IO_CHECK_IF_POSSIBLE,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_NETWORK_QUERY_OPEN,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_MDL_READ,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_MDL_READ_COMPLETE,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_PREPARE_MDL_WRITE,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_MDL_WRITE_COMPLETE,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_VOLUME_MOUNT,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_VOLUME_DISMOUNT,<br>      <span class="hljs-number">0</span>,<br>      PtPreOperationPassThrough,<br>      PtPostOperationPassThrough &#125;,<br><br>    &#123; IRP_MJ_OPERATION_END &#125;<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>驱动卸载：调用 FltUnregisterFilter卸载回调</p></li><li><p>过滤函数</p><ul><li>PreNtCreateFile：返回值类型 FLT_PPREOP_CALLBACK_STATUS<ul><li>几种返回值类型<ul><li><strong>FLT_PREROP_SUCCESS_WITH_CALLBACK</strong>：向下传递，完成irp后会调用post</li><li><strong>FLT_PREOP_SUCCESS_NO_CALLBACK</strong>：向下传递，完成irp后不会调用post</li><li>FLT_PREOP_PENDING</li><li>FLT_PREOP_DISALLOC_FASTIO</li><li><strong>FLT_PREOP_COMPLETE</strong>：直接完成irp，不向下传递</li><li>FLT_PREOP_SYNCHRONIZE</li></ul></li></ul></li><li>PostNtCreateFile：在irp完成之后，在这里拿到文件名等其他信息。<ul><li>几种返回值类型<ul><li><strong>FLT_POSTOP_FINISHED_PROCESSING</strong>：</li><li>FLT_POSTOP_MORE_PROCESSING_REQUIRED</li></ul></li></ul></li><li>判断Data是什么操作的宏<ul><li>FLT_IS_IRP_OPERATION</li><li>FLT_IS_FASTIO_OPERATION</li><li>FLT_IS_FS_FILTER_OPERATION</li></ul></li></ul></li><li><p>监控进程创建</p><ul><li>进程创建因为是映射内存区，底层函数是NtCreateSection</li><li>IRP 是：IRP_MJ_ACQUIRE_FOR_SECITON_SYNCHRONIZATION，且data-&gt;iopb-&gt;Parameters.AcquireForSectionsSynchronization.PageProtection == Page_execute</li></ul></li><li><p>过滤函数中获取参数</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 过滤函数的参数中有 Data</span><br>PFLT_CALLBACK_DATA Data；<br><span class="hljs-comment">// 获取进程对象</span><br>PEPROCESS processObject = <br>		Data-&gt;Thread ? IoThreadToProcess(Data-&gt;Thread) : PsGetCurrentProcess();<br><span class="hljs-comment">// 获取当前进程PID</span><br>HandleToUlong(PsGetProcessId(processObject));<span class="hljs-comment">//PID</span><br><br><span class="hljs-comment">// 要返回给请求者的状态码</span><br>Data-&gt;IoStatus.Status = ntStatus;<br>Data-&gt;IoStatus.Information = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// 文件相关参数</span><br>FltObjects-&gt;Volume,<br>FltObjects-&gt;Instance,<br>FltObjects-&gt;FileObject,<br>FltObjects-&gt;FileObject-&gt;DeviceObject<br><br>Data-&gt;Iopb-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess<br><br>PVOID	pQueryBuffer 	= <br>		Data-&gt;Iopb-&gt;Parameters.DirectoryControl.QueryDirectory.DirectoryBuffer;<br>ULONG	uQueryBufferSize 	=  <br>		Data-&gt;Iopb-&gt;Parameters.DirectoryControl.QueryDirectory.Length<br><br>PMDL pReadMdl 		    = Data-&gt;Iopb-&gt;Parameters.Read. MdlAddress;<br>PVOID pReadBuffer 		= Data-&gt;Iopb-&gt;Parameters.Read. ReadBuffer;<br>ULONG uReadLength 		= Data-&gt;Iopb-&gt;Parameters.Read.Length;<br><br><br>Data-&gt;IoStatus.Status = STATUS_ACCESS_DENIED;<br>Data-&gt;IoStatus.Information = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> FLT_PREOP_COMPLETE;<br></code></pre></td></tr></table></figure><ul><li>路径获取</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 在postcreate里获得</span><br><br>PFLT_FILE_NAME_INFORMATION	pNameInfo = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 这里没有分配内存，解析函数会分配内存，记得释放</span><br><br>ntStatus = FltGetFileNameInformation(Data,<br>		FLT_FILE_NAME_NORMALIZED| <br>		FLT_FILE_NAME_QUERY_DEFAULT,<br>		&amp;pNameInfo);<br>FltParseFileNameInformation(pNameInfo);<br><br>pNameInfo-&gt;Name.Buffer <span class="hljs-comment">// 依然是一个设备名路径，依然有长短名之分</span><br>pNameInfo-&gt;Volume<br><br>FltReleaseFileNameInformation(pNameInfo); <span class="hljs-comment">//记得释放内存</span><br><br><span class="hljs-comment">// 重命名的获得：</span><br>PFILE_RENAME_INFORMATION <br>    pFileRenameInfomation = (PFILE_RENAME_INFORMATION)Data-&gt;Iopb-&gt;Parameters.SetFileInformation.InfoBuffer;<br><br>或者使用这个函数 FltGetDestinationFileNameInformation <span class="hljs-comment">//重命名获得</span><br></code></pre></td></tr></table></figure><ul><li><p>Pre和Post函数的 IRQL</p><ul><li>a preoperation callback routine can be called at IRQL = PASSIVE_LEVEL or at IRQL = APC_LEVEL. Typically it is called at IRQL = PASSIVE_LEVEL</li><li>If a minifilter driver’s preoperation callback routine returns FLT_PREOP_SYNCHRONIZE for an IRP-based I/O operation, the corresponding postoperation callback routine is called at IRQL &lt;= APC_LEVEL, in the same thread context as the preoperation callback routine.</li><li>The postoperation callback routine for a fast I/O operation is called at IRQL = PASSIVE_LEVEL, in the same thread context as the preoperation callback routine.</li><li>Post-create callback routines are called at IRQL = PASSIVE_LEVEL, in the context of the thread that originated the IRP_MJ_CREATE operation.</li></ul></li><li><p>minifilter中的文件操作：使用 FLT 系列函数，防止重入</p><ul><li>FltCreateFile</li><li>FltReadFile</li><li>FltWriteFile</li><li>FltClose</li><li>FltQueryXXXX</li><li>FltSetXXXX</li><li>FltGetXXXX</li><li>FltPerformXXXx</li></ul></li><li><p>上下文概念</p><ul><li>先复习一下传统过滤设备中的设备扩展概念，我们可以在创建设备的时候生成设备扩展，可以在设备扩展中记录一些跟当前设备有关的信息，在minifilter中，这就是context上下文。<ul><li>申请：<code>FltAllocateContext(g_pFilter, FLR_INSTANCE_CONTEXT, SIZE, PAGEDPOOL, &amp;pInstanceText)</code></li><li>释放：<code>FltReleaseContext(pInstanceText)</code>：<strong>使用引用计数管理，当计数为0时，会调用在注册minifilter时提供的contextRegistron的清理函数。</strong>（因为我们申请的context内部还有可能是指针，句柄等）</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 上下文的内容由我们自己定义</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">INSTANCE_CONTEXT</span> &#123;</span><br>…<br>&#125; INSTANCE_CONTEXT, *PINSTANCE_CONTEXT;<br><br><span class="hljs-comment">//分配与设置</span><br>PINSTANCE_CONTEXT pContext = <span class="hljs-literal">NULL</span>;<br>ntStatus = FltGetInstanceContext(FltObjects-&gt;Instance, &amp; pContext);<br><span class="hljs-keyword">if</span>(NT_SUCCESS(Status) == FALSE)<br>&#123;<br>	ntStatus = FltAllocateContext(g_pFilter,FLT_INSTANCE_CONTEXT,<br>		<span class="hljs-keyword">sizeof</span>(INSTANCE_CONTEXT),<br>		PagedPool,&amp; pContext);<br>	<span class="hljs-keyword">if</span>(NT_SUCCESS(Status) == FALSE)<br>	&#123;<br>		<span class="hljs-keyword">return</span> STATUS_SUCCESS;<br>	&#125;<br>	RtlZeroMemory(pContext, <span class="hljs-keyword">sizeof</span>(INSTANCE_CONTEXT));<br>&#125;<br><span class="hljs-comment">// 分配完，存储一下自定义的数据</span><br>pContext -&gt;m_DeviceType = VolumeDeviceType;<br>pContext-&gt;m_FSType = VolumeFilesystemType;<br>FltSetInstanceContext(FltObjects-&gt;Instance, 		FLT_SET_CONTEXT_REPLACE_IF_EXISTS,pContext,<span class="hljs-literal">NULL</span>);<span class="hljs-comment">// 引用计数加一</span><br><span class="hljs-keyword">if</span> (pContext)<br>&#123;<br>	FltReleaseContext(pContext);<span class="hljs-comment">//引用计数减一</span><br>&#125;<br><br><span class="hljs-comment">//获取访问</span><br>PINSTANCE_CONTEXT pContext = <span class="hljs-literal">NULL</span>;<br>Status = FltGetInstanceContext(FltObjects-&gt;Instance,&amp;pContext);<br>pContext-&gt;xxx = xxx;<br></code></pre></td></tr></table></figure><ul><li><p>分类</p><ul><li><p>Stream context 流上下文：对应 Fcb 文件控制块，一个文件在系统中只有一个文件控制块</p><ul><li><code>FltGetStreamContext</code></li><li><code>FltSetStreamContext</code></li></ul></li><li><p>Stream Handle context 流句柄上下文：对应fileObject，一个文件可以被打开多次，每次对应一个文件对象</p><ul><li><code>FltGetStreamHandleContext</code></li><li><code>FltSetStreamHandleContext</code></li><li>可以在这里记录写关闭信息</li></ul></li><li><p>Instance context 实例上下文：对应在sfilter中为每个文件系统设备栈创建的一个过滤设备实例，与卷上下文一一对应，一般使用本上下文。</p><ul><li><code>FltGetInstanceContext</code></li><li><code>FltSetInstanceContext</code></li></ul></li><li><p>Volume Context 卷上下文：卷就是通常看到的 CDE盘，以及网络重定向器。一般情况下一个卷对应一个过滤器实例对象，实际应用中经常用实例上下文代替卷上下文。</p><ul><li><code>FltGetVolumeContext</code></li><li><code>FltSetVolumeContext</code></li></ul></li><li><p>文件上下文（vista之后）：没咋用过</p><ul><li><code>FltGetFileContext</code></li><li><code>FltSetFileContext</code></li></ul></li></ul></li></ul><h3 id="minifilter-中的通讯框架-太方便了"><a href="#minifilter-中的通讯框架-太方便了" class="headerlink" title="minifilter 中的通讯框架(太方便了)"></a>minifilter 中的通讯框架(太方便了)</h3></li><li><p>基于port的r0与r3通信</p><ul><li><p>框架：分为r3主动还是r0主动<img src="https://github.com/killaragorn/blog_image/raw/main/images/20210415105118.png" srcset="/img/loading.gif" lazyload alt="image-20210408093619794"></p></li><li><p>r3 主动与r0 通信：</p><ul><li>r0建立通信端口</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">FltCreateCommunicationPort(g_pFiter, <br>                           &amp;oa(端口名字), <br>                           <span class="hljs-literal">NULL</span>, <br>                           fnConnectFromClient, <span class="hljs-comment">// 获得r3端口</span><br>                           fnDisconnectFromClient, <span class="hljs-comment">// 断开连接处理</span><br>                           fnMessageFromClient);<span class="hljs-comment">// 处理从R3 FilterSendMessage的请求r3连接通信端口</span><br></code></pre></td></tr></table></figure><ul><li>r3主动连接，发送消息</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">FilterConnectCommunicationPort( ScannerPortName,<span class="hljs-comment">//与R0的名字一致</span><br>                                         	       <span class="hljs-number">0</span>,<br>		                          	       <span class="hljs-literal">NULL</span>,<br>                                         	       <span class="hljs-number">0</span>,<br>                                         	       <span class="hljs-literal">NULL</span>,<br>                                         	       &amp;Port );<span class="hljs-comment">//R0端口</span><br><span class="hljs-comment">//主动发请求给R0</span><br> FilterSendMessage(<br>	Port,<br>	request,<br>	<span class="hljs-keyword">sizeof</span>(REQUEST),<br>	reply ? reply : <span class="hljs-literal">NULL</span>,<br>	reply ? <span class="hljs-keyword">sizeof</span>(REPLY) : <span class="hljs-number">0</span>,<br>	&amp;dwRtn);<br><br></code></pre></td></tr></table></figure><ul><li>r0处理消息（类似DeviceIoControl，使用Neither IO 方式，需要 ProbeXXXX ，并且 try 块包含）</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c">NTSTATUS<br>fnMessageFromClient(<br>      IN PVOID PortCookie,<br>      IN PVOID InputBuffer OPTIONAL,<br>      IN ULONG InputBufferLength,<br>      OUT PVOID OutputBuffer OPTIONAL,<br>      IN ULONG OutputBufferLength,<br>      OUT PULONG ReturnOutputBufferLength<br>      )<br>&#123;<br>	__try<br>	&#123;<br>		ProbeForRead(InputBuffer, InputBufferLength, <span class="hljs-keyword">sizeof</span>(ULONG));<br>		<span class="hljs-comment">//GET InputBuffer</span><br>		<span class="hljs-comment">//Do something</span><br>		ProbeForWrite(OutputBuffer, OutputBufferLength, <span class="hljs-keyword">sizeof</span>(ULONG));<br>		<span class="hljs-comment">//Copy Result to Outputbuffer</span><br>	&#125;<br>	__except(EXCEPTION_EXECUTE_HANDLER)<br>	&#123;<br>		<span class="hljs-keyword">return</span> STATUS_NOT_IMPLEMENTED;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> STATUS_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>r0主动与r3通信（主要）</p><ul><li>r0 建立通信端口</li><li>r3 连接通信端口</li><li>r0 向客户端端口发送数据</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">FltSendMessag(g_pFilter, &amp;g_pClientPort, &amp;request, requestSize, &amp;reply, replySize, &amp;timeOut);<br></code></pre></td></tr></table></figure><ul><li>r3 等待通信，处理之后回复r0</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">FilterConnectCommunicationPort( ScannerPortName,<span class="hljs-comment">//与R0的名字一致</span><br>                                         	       <span class="hljs-number">0</span>,<br>		                          	       <span class="hljs-literal">NULL</span>,<br>                                         	       <span class="hljs-number">0</span>,<br>                                         	       <span class="hljs-literal">NULL</span>,<br>                                         	       &amp;Port );<span class="hljs-comment">//R0端口</span><br><br><span class="hljs-comment">//处理从R0来的请求，即R0调用FltSendMessage的请求 使用IOCP模型</span><br>completion = CreateIoCompletionPort( port,<span class="hljs-literal">NULL</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br>FilterGetMessage( Port,<br>			&amp;message-&gt;MessageHeader,<br>			FIELD_OFFSET( SANDBOX_MESSAGE, Ovlp ),<br>			&amp;message-&gt;Ovlp ); <span class="hljs-comment">// 异步调用，下面使用GetQueuedCompletionStatus来等待r0消息</span><br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>&#123;<br><span class="hljs-comment">// 这里一直阻塞直到r0有消息发来</span><br>GetQueuedCompletionStatus(Completion, &amp;outSize, &amp;key, &amp;pOvlp, INFINITE );<br><br><span class="hljs-comment">// 用户弹窗等处理。。。</span><br>FilterReplyMessage(Port,<br>			(PFILTER_REPLY_HEADER) &amp;replyMessage,<br>			<span class="hljs-keyword">sizeof</span>( replyMessage ) );<span class="hljs-comment">// 这里r0会接收到消息， fnMessageFromClient 进行处理</span><br>FilterGetMessage( Port,<br>			&amp;message-&gt;MessageHeader,<br>			FIELD_OFFSET( SANDBOX_MESSAGE, Ovlp ),<br>			&amp;message-&gt;Ovlp ); <span class="hljs-comment">// 再次发起异步请求。</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>从 CALL_BACK_DATA 中获取R3的缓冲区</p></li></ul><h3 id="Minifilter-sample-Scanner-代码解析"><a href="#Minifilter-sample-Scanner-代码解析" class="headerlink" title="Minifilter sample Scanner 代码解析"></a>Minifilter sample Scanner 代码解析</h3><ul><li>简介：检测 txt inf doc cmd bat这些后缀文件中打开，写，写关闭时是否有病毒字符串“foul”</li><li>驱动<ul><li>驱动入口<ul><li>创建安全描述符，仅允许amdin和system用户打开通讯端口</li><li>创建通讯端口（示例代码没有注册接收r3消息的函数，可以添加函数，接收r3动态下发规则）</li><li>启动过滤</li></ul></li><li>ScannerPortConnect：接收客户端连接（此时可以进行连接校验），保存客户端process结构和客户端端口，方便之后使用。</li><li>ScannerPortDisConnect：断开客户端连接</li><li>拦截IRP<ul><li>precreate</li><li>postcreate：判断是否是感兴趣的文件，扫描文件内容发给r3判断，如果r3拒绝，取消当前irp。判断当前打开方式是否是写打开，如果是，申请流句柄上下文，存储写相关的信息</li><li>PreWrite<ul><li>没有客户端连接，直接返回</li><li>获取流句柄上下文：如果获取失败，说明不是Scanner感兴趣的数据，直接返回</li><li>获取缓冲<ul><li>如果data-&gt;iopb-&gt;parameters.write.mdladdress 不为空，说明该使用的就是direct io，使用mmgetsystemaddresformdlsafe 构建内核地址</li><li>如果mdladdress为空，直接使用data-&gt;iopb-&gt;parameters.write.writebuffer</li><li>申请空间，拷贝buffer到空间中，注意要try包含，使用了用户空间地址</li><li>发送r3判断。。。</li></ul></li></ul></li><li>precleanup<ul><li>没有客户端连接，直接返回</li><li>获取流句柄上下文：如果获取失败，说明不是Scanner感兴趣的数据，直接返回</li><li>判断是否是写关闭<ul><li>打开文件，读取文件，发送r3判断</li><li>也可以直接发送文集路径给r3，由r3去全权操作。</li></ul></li><li>根据结果<ul><li>有问题：删除，询问，放入隔离区</li></ul></li></ul></li></ul></li><li>获取信息，发送r3判断<ul><li>获取扇区大小，仅读取固定的大小的数据去判断</li><li>申请空间</li><li>读文件内容</li><li>发送信息，等待r3判断</li><li>函数返回，表示是否允许</li></ul></li></ul></li><li>应用程序</li></ul><h3 id="Minifilter-安装与运行"><a href="#Minifilter-安装与运行" class="headerlink" title="Minifilter 安装与运行"></a>Minifilter 安装与运行</h3><ul><li>有写好的inf文件<ul><li>可以使用SetupCopyOEMInf 函数来安装</li><li>可以右键单击inf安装</li></ul></li><li>代码安装<ul><li>创建Instances 子键</li><li>创建Default Instance 子键<ul><li>创建键值 Altitude “xxxxx”</li></ul></li></ul></li><li>控制 minifilter<ul><li>启动<ul><li>net start Nullfilter</li><li>sc start Nullfilter</li><li>fltmc load nullfilter</li></ul></li><li>停止<ul><li>net stop nullfilter</li><li>sc stop nullfilter</li><li>fltmc unload nullfilter</li></ul></li></ul></li></ul></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/">windows驱动开发</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/">windows驱动开发</a> <a class="hover-with-bg" href="/tags/Minifilter/">Minifilter</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/2021/04/09/%E6%B2%99%E7%AE%B1%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">沙箱实现原理</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021/04/07/sfilter%E8%BF%87%E6%BB%A4%E6%A1%86%E6%9E%B6%E5%A4%8D%E4%B9%A0/"><span class="hidden-mobile">sfilter过滤框架复习</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/killaragorn/" target="_blank" rel="nofollow noopener"><span>KillAragorn</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/js/local-search.js"></script><script>$("#local-search-input").on("click",(function(){searchFunc("/local-search.xml","local-search-input","local-search-result")})),$("#modalSearch").on("shown.bs.modal",(function(){$("#local-search-input").focus()}))</script><script src="/js/boot.js"></script></body></html>